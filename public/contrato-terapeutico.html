<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Terapêutico - EuPsico</title>
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Poppins', sans-serif; color: #333; line-height: 1.6; }
        .contract-container { max-width: 800px; margin: 40px auto; padding: 40px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .contract-header { text-align: center; margin-bottom: 30px; }
        .contract-header img { max-width: 150px; margin-bottom: 20px; }
        h1, h2 { color: var(--cor-primaria); border-bottom: 2px solid var(--cor-secundaria); padding-bottom: 10px; margin-top: 30px; }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; }
        .data-section { background-color: #f9f9f9; border-left: 4px solid var(--cor-primaria); padding: 20px; margin-top: 20px; border-radius: 4px; }
        .acceptance-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .hidden { display: none; }
        #contract-loading { text-align: center; padding: 40px; }
        .error-message, .feedback-error { color: #d93025; font-weight: bold; }
        .feedback-success { color: #188038; font-weight: bold; }
    </style>
</head>
<body>

    <div class="contract-container">
        <div class="contract-header">
            <img src="../assets/img/logo-eupsico.png" alt="Logo EuPsico">
            <h1>CONTRATO DE PRESTAÇÃO DE SERVIÇOS TERAPÊUTICOS</h1>
        </div>

        <div id="contract-loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados do contrato...</p>
        </div>
        
        <div id="contract-error" class="error-message hidden"></div>

        <div id="contract-content" class="hidden">
            
            <h2>1. DOS PAPÉIS DE CADA PARTE</h2>
            <p>Ao <strong>TERAPEUTA</strong>, cabe a escuta técnica e reflexiva sem julgamentos...</p>
            <h2>7. DA RESCISÃO CONTRATUAL</h2>
            <p>O Presente contrato poderá ser rescindido nas modalidades a seguir...</p>

            <div class="data-section">
                <h3>Dados do Atendimento</h3>
                <p><strong>Terapeuta:</strong> <span id="data-terapeuta"></span></p>
                <p><strong>Nome completo do PACIENTE:</strong> <span id="data-paciente-nome"></span></p>
                <div id="responsavel-section" class="hidden">
                    <p><strong>Nome do Responsável Legal:</strong> <span id="data-responsavel-nome"></span></p>
                </div>
                <p><strong>Data de nascimento do PACIENTE:</strong> <span id="data-paciente-nascimento"></span></p>
                <p><strong>Valor da contribuição mensal:</strong> <span id="data-contribuicao"></span></p>
            </div>
            
            <div class="data-section">
                <h3>Dados da Sessão</h3>
                <p><strong>Dia da sessão:</strong> <span id="data-dia-sessao"></span></p>
                <p><strong>Horário do atendimento:</strong> <span id="data-horario-sessao"></span></p>
                <p><strong>Tipo de atendimento:</strong> <span id="data-tipo-atendimento"></span></p>
            </div>

            <div id="clausula-menor-idade-section" class="hidden">
                <h2>AUTORIZAÇÃO PARA ACOMPANHAMENTO PSICOTERAPÊUTICO DE CRIANÇAS E ADOLESCENTES (MENORES DE 18 ANOS)</h2>
                <p>Eu como RESPONSÁVEL LEGAL pela(o) criança/adolescente (PACIENTE), autorizo o acompanhamento terapêutico e os encaminhamentos cabíveis.</p>
                <p>Todas as intervenções e documentos produzidos serão regidos pelos dispositivos legais vigentes, em especial pelo disposto na Resolução CFP nº10, de 2005 (Código de Ética Profissional do Psicólogo), bem como pelas demais Resoluções da Psicologia relacionadas ao exercício da profissão.</p>
                <p>Em especial, serão garantidos à(s) criança(s) ou adolescente(s) o sigilo das informações e a preservação da dignidade e da intimidade durante a prestação dos serviços de que trata esta autorização.</p>
            </div>

            <div id="acceptance-form-section" class="acceptance-section">
                <h2>ACEITE DOS TERMOS E CONDIÇÕES</h2>
                <p>Ao preencher o formulário abaixo e confirmar digitalmente, declaro ter ciência e concordar com todos os termos propostos.</p>
                <form id="signature-form" novalidate>
                    <div class="form-group">
                        <label for="signer-name" id="signer-name-label">Nome Completo (de quem assina o contrato):</label>
                        <input type="text" id="signer-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="signer-cpf" id="signer-cpf-label">CPF (de quem assina o contrato):</label>
                        <input type="text" id="signer-cpf" class="form-control" required maxlength="14">
                        <div id="cpf-feedback" class="feedback-error" style="font-size: 0.9em; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <p><strong>Declaro ter ciência e concordar com os termos propostos.</strong></p>
                        <label><input type="radio" name="agreement" value="concordo" required> Concordo</label>
                        <label><input type="radio" name="agreement" value="nao-concordo"> Não concordo</label>
                    </div>
                    <button type="submit" class="action-button">Assinar Contrato</button>
                    <div id="signature-feedback" style="margin-top: 15px;"></div>
                </form>
            </div>
            
            <div id="thank-you-section" class="acceptance-section hidden">
                <h2>Obrigado!</h2>
                <p>O contrato foi assinado digitalmente com sucesso. A EuPsico foi notificada.</p>
            </div>
        </div>
    </div>

    <script type="module">
      import { db, doc, getDoc, updateDoc, serverTimestamp } from '../assets/js/firebase-init.js';

      // --- FUNÇÕES AUXILIARES ---

      function showError(message) {
          const errorDiv = document.getElementById('contract-error');
          errorDiv.textContent = message;
          errorDiv.classList.remove('hidden');
          document.getElementById('contract-loading').classList.add('hidden');
          document.getElementById('contract-content').classList.add('hidden');
      }

      function calculateAge(birthDateString) {
          if (!birthDateString) return null;
          const today = new Date();
          const birthDate = new Date(birthDateString + "T03:00:00");
          let age = today.getFullYear() - birthDate.getFullYear();
          const m = today.getMonth() - birthDate.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
              age--;
          }
          return age;
      }

      function validaCPF(cpf) {
          cpf = String(cpf).replace(/[^\d]/g, '');
          if (cpf.length !== 11) return false;
          if (/^(\d)\1+$/.test(cpf)) return false; // Verifica sequências repetidas
          
          let soma = 0;
          let resto;
          
          for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
          resto = (soma * 10) % 11;
          if (resto === 10 || resto === 11) resto = 0;
          if (resto !== parseInt(cpf.substring(9, 10))) return false;
          
          soma = 0;
          for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
          resto = (soma * 10) % 11;
          if (resto === 10 || resto === 11) resto = 0;
          if (resto !== parseInt(cpf.substring(10, 11))) return false;
          
          return true;
      }

      // --- SCRIPT PRINCIPAL ---

      document.addEventListener('DOMContentLoaded', async () => {
        const loadingDiv = document.getElementById('contract-loading');
        const contentDiv = document.getElementById('contract-content');

        const urlParams = new URLSearchParams(window.location.search);
        const pacienteId = urlParams.get('id');
        const atendimentoId = urlParams.get('atendimentoId');

        if (!pacienteId || !atendimentoId) {
            showError("Erro: Parâmetros inválidos. O link do contrato está incompleto.");
            return;
        }

        try {
            const docRef = doc(db, 'trilhaPaciente', pacienteId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                showError("Erro: Paciente não encontrado.");
                return;
            }

            const pacienteData = docSnap.data();
            const meuAtendimento = pacienteData.atendimentosPB?.find(at => at.atendimentoId === atendimentoId);

            if (!meuAtendimento) {
                showError("Erro: Atendimento específico não localizado para este paciente.");
                return;
            }

            // Lógica para menor de idade
            const idade = calculateAge(pacienteData.dataNascimento);
            const isMenor = idade !== null && idade < 18;

            if (isMenor) {
                document.getElementById('clausula-menor-idade-section').classList.remove('hidden');
                if (pacienteData.responsavel && pacienteData.responsavel.nome) {
                    document.getElementById('responsavel-section').classList.remove('hidden');
                    document.getElementById('data-responsavel-nome').textContent = pacienteData.responsavel.nome;
                }
                document.getElementById('signer-name-label').textContent = 'Nome Completo do Responsável Legal:';
                document.getElementById('signer-cpf-label').textContent = 'CPF do Responsável Legal:';
            }

            // Preenche os dados na página
            document.getElementById('data-terapeuta').textContent = meuAtendimento.profissionalNome || 'Não informado';
            document.getElementById('data-paciente-nome').textContent = pacienteData.nomeCompleto || 'Não informado';
            document.getElementById('data-paciente-nascimento').textContent = new Date(pacienteData.dataNascimento + 'T03:00:00').toLocaleDateString('pt-BR');
            document.getElementById('data-contribuicao').textContent = `R$ ${pacienteData.valorContribuicao || '0,00'}`;

            const horarioInfo = meuAtendimento.horarioSessao || {};
            document.getElementById('data-dia-sessao').textContent = horarioInfo.diaSemana || 'A definir';
            document.getElementById('data-horario-sessao').textContent = horarioInfo.horario || 'A definir';
            document.getElementById('data-tipo-atendimento').textContent = horarioInfo.tipoAtendimento || 'A definir';

            // Exibe o conteúdo e lida com o formulário
            loadingDiv.classList.add('hidden');
            contentDiv.classList.remove('hidden');

            if (meuAtendimento.contratoAssinado) {
                document.getElementById('acceptance-form-section').classList.add('hidden');
                document.getElementById('thank-you-section').classList.remove('hidden');
            }

            // Configura a máscara e validação do CPF em tempo real
            const cpfInput = document.getElementById('signer-cpf');
            const cpfFeedback = document.getElementById('cpf-feedback');
            cpfInput.addEventListener('input', () => {
                let value = cpfInput.value.replace(/\D/g, '');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                cpfInput.value = value;
                
                // Validação em tempo real após o campo estar completo
                if (value.length === 14) {
                    if (validaCPF(value)) {
                        cpfFeedback.textContent = '';
                    } else {
                        cpfFeedback.textContent = 'CPF inválido.';
                    }
                } else {
                    cpfFeedback.textContent = '';
                }
            });
            
            // Configura o formulário de assinatura
            const signatureForm = document.getElementById('signature-form');
            signatureForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const feedbackDiv = document.getElementById('signature-feedback');
                const submitButton = signatureForm.querySelector('button');
                const cpfValue = document.getElementById('signer-cpf').value;

                // Validação final do CPF no momento do envio
                if (!validaCPF(cpfValue)) {
                    feedbackDiv.textContent = 'O CPF informado não é válido. Por favor, corrija.';
                    feedbackDiv.className = 'feedback-error';
                    return;
                }

                const agreement = signatureForm.elements['agreement'].value;
                if (agreement !== 'concordo') {
                    feedbackDiv.textContent = 'Você precisa concordar com os termos para assinar.';
                    feedbackDiv.className = 'feedback-error';
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Salvando...';
                feedbackDiv.textContent = '';

                try {
                    const signatureData = {
                        nomeSignatario: document.getElementById('signer-name').value,
                        cpfSignatario: cpfValue,
                        assinadoEm: serverTimestamp()
                    };

                    const novosAtendimentos = pacienteData.atendimentosPB.map(at => {
                        if (at.atendimentoId === atendimentoId) {
                            return { ...at, contratoAssinado: signatureData };
                        }
                        return at;
                    });
                    
                    const updateData = {
                        atendimentosPB: novosAtendimentos,
                        status: 'em_atendimento_pb',
                        lastUpdate: serverTimestamp()
                    };

                    await updateDoc(docRef, updateData);

                    document.getElementById('acceptance-form-section').classList.add('hidden');
                    document.getElementById('thank-you-section').classList.remove('hidden');

                } catch (error) {
                    console.error("Erro ao salvar assinatura:", error);
                    feedbackDiv.textContent = 'Erro ao salvar a assinatura. Tente novamente.';
                    feedbackDiv.className = 'feedback-error';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Assinar Contrato';
                }
            });

        } catch (error) {
            console.error("Erro ao carregar o contrato:", error);
            showError("Ocorreu um erro inesperado ao carregar o contrato.");
        }
      });
    </script>
</body>
</html>