<style>
    .ata-body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 25px; position: relative; }
    .ata-body::after { content: ""; background: url('https://i.ibb.co/Kj3q3XNk/Nova2.jpg') no-repeat center center; background-size: contain; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80vw; height: 80vh; opacity: 0.08; z-index: -1; }
    .ata-container { max-width: 900px; margin: 0 auto; }
    .ata-h1 { background-color: #04396d; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; font-size: 1.8em; text-align: center; }
    .ata-card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-title-label { background-color: #1d70b7; color: white; padding: 8px 12px; border-radius: 5px; display: block; margin-bottom: 8px; }
    .ata-label { font-weight: bold; color: #555; }
    .participantes-checkbox-container div .ata-label { display: flex; align-items: center; font-weight: normal; color: #333; }
    .participantes-checkbox-container div .ata-label input[type="checkbox"] { width: auto; margin-right: 8px; }
    .ata-input, .ata-textarea, .ata-select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
    .error-message { color: #dc3545; font-weight: bold; font-size: 0.85em; margin-top: 4px; display: block; height: 1em; }
    .action-button { border: none; padding: 10px 20px; font-size: 1em; font-weight: bold; border-radius: 5px; cursor: pointer; color: white; text-decoration: none; display: inline-block; text-align: center; }
    .save-btn { background-color: #28a745; float: right; }
    .save-btn:disabled { background-color: #aaa; cursor: not-allowed; }
    .add-activity-btn { background-color: #007bff; color: white; width: 100%; margin-top: 10px; }
    .participantes-checkbox-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; background-color: #f9f9f9; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .plano-de-acao { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; }
    #lista-atividades { margin-top: 15px; }
    .atividade-item { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 5px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .message-box { padding: 20px; text-align: center; font-size: 1.1em; border-radius: 8px; }
    .message-box.success { background-color: #d4edda; color: #155724; }
    .page-header { text-align: center; margin-bottom: 20px; }
    .page-header img { max-width: 250px; height: auto; }
    .status-message { padding: 15px; margin-bottom: 20px; border-radius: 5px; font-weight: bold; text-align: center; display: none; }
    .status-message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
</style>

<div class="ata-body">
    <div class="page-header">
        <img src="https://i.ibb.co/JwVcskKb/Saude-Mental.png" alt="Logo Saúde Mental EuPsico">
    </div>

    <div class="ata-container">
        <h1 class="ata-h1">Registro de Atas EuPsico</h1>
        <div class="ata-card" id="new-ata-card-container">
            </div>
    </div>
</div>

<script>
    (function() {
        const database = firebase.database();
        const container = document.getElementById('new-ata-card-container');
        if (!container) return;

        let atividadesPlanoAcao = [];
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyqUqnwTJX1yh3i5h8CNJJ0r0u0MqI6Pvbte0lnuyVKStS7UR28czQWyQzUhp8X3pIaaQ/exec";

        function createNewAtaForm() {
            atividadesPlanoAcao = [];
            container.innerHTML = `
                <div class="form-group"><label class="form-title-label">Tipo de Reunião</label><select class="ata-select ata-tipo"><option value="" disabled selected>Selecione...</option><option value="Reunião Conselho administrativo">Reunião Conselho administrativo</option><option value="Reunião com Gestor">Reunião com Gestor</option><option value="Reunião Técnica">Reunião Técnica</option><option value="Outros">Outros</option></select><span class="error-message"></span></div>
                <div class="form-group gestor-select-field" style="display: none;"><label class="form-title-label">Nome do Gestor</label><select class="ata-select ata-nome-gestor"><option value="">Selecione...</option></select><span class="error-message"></span></div>
                <div class="form-group"><label class="form-title-label">Data da Reunião</label><input type="date" class="ata-input ata-date"><span class="error-message"></span></div>
                <div class="form-group"><label class="form-title-label">Hora de Início</label><input type="time" class="ata-input ata-start-time"><span class="error-message"></span></div>
                <div class="form-group"><label class="form-title-label">Hora de Fim</label><input type="time" class="ata-input ata-end-time"><span class="error-message"></span></div>
                <div class="form-group tecnica-field duracao-field-container" style="display: none;"><label class="form-title-label">Duração (minutos)</label><input type="number" class="ata-input ata-duracao"><span class="error-message"></span></div>
                <div class="form-group tecnica-field" style="display: none;"><label class="form-title-label">Responsável</label><input type="text" class="ata-input ata-responsavel-tecnica"><span class="error-message"></span></div>
                <div class="form-group participantes-field" style="display: none;"><label class="form-title-label">Participantes</label><div class="participantes-checkbox-container" style="display: none;"></div><input type="text" class="ata-input ata-participantes-input" style="display: none;" placeholder="Nomes separados por vírgula"><span class="error-message"></span></div>
                <div class="form-group"><label class="form-title-label" id="pauta-label">Tema da Reunião</label><textarea class="ata-textarea ata-pauta" rows="3"></textarea><span class="error-message"></span></div>
                <div class="form-group gestao-field" style="display: none;"><label class="form-title-label">Pontos Discutidos</label><textarea class="ata-textarea ata-pontos" rows="4"></textarea><span class="error-message"></span></div>
                <div class="form-group gestao-field" style="display: none;"><label class="form-title-label">Decisões</label><textarea class="ata-textarea ata-decisoes" rows="4"></textarea><span class="error-message"></span></div>
                <div class="form-group gestao-field plano-de-acao" style="display: none;"><label class="form-title-label">Plano de Ação</label><div class="form-group"><label class="ata-label">Responsável</label><select id="plano-responsavel" class="ata-select"><option value="">Selecione...</option></select></div><div class="form-group"><label class="ata-label">Descrição</label><textarea id="plano-descricao" class="ata-textarea" rows="3"></textarea></div><div class="form-group"><label class="ata-label">Prazo</label><input type="date" id="plano-prazo" class="ata-input"></div><button type="button" class="action-button add-activity-btn" id="add-activity">Adicionar Atividade</button><span id="activity-error-feedback" class="error-message" style="text-align:center;"></span><div id="lista-atividades"></div></div>
                <div class="form-group gestao-field" style="display: none;"><label class="form-title-label">Temas p/ Próxima Reunião</label><textarea class="ata-textarea ata-temas-proxima" rows="3"></textarea><span class="error-message"></span></div>
                <div class="form-group gestao-field" style="display: none;"><label class="form-title-label">Data da Próxima Reunião</label><input type="datetime-local" class="ata-input ata-proxima-reuniao"><span class="error-message"></span></div>
                <div id="form-status-message" class="status-message"></div>
                <div><button type="button" class="action-button save-btn">Salvar Ata</button></div>
            `;
            populateAllDropdowns();
            setupEventListeners();
        }

        function populateAllDropdowns() {
            const gestorSelect = container.querySelector('.ata-nome-gestor');
            const responsavelSelect = container.querySelector('#plano-responsavel');
            const checkboxContainer = container.querySelector('.participantes-checkbox-container');
            
            database.ref('financeiro/profissionais').once('value', snapshot => {
                if (snapshot.exists()) {
                    const profissionaisData = snapshot.val();
                    const profissionaisArray = Array.isArray(profissionaisData) ? profissionaisData : Object.values(profissionaisData);
                    const gestorNames = profissionaisArray.filter(p => p && p.gestor).map(p => p.eupsico).sort();
                    if(gestorNames.length === 0) return;

                    checkboxContainer.innerHTML = gestorNames.map(name => `<div><label class="ata-label"><input type="checkbox" class="participante-check" value="${name}"> ${name}</label></div>`).join('');
                    gestorNames.forEach(name => {
                        gestorSelect.innerHTML += `<option value="${name}">${name}</option>`;
                        responsavelSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    });
                }
            });
        }

        function renderPlanoAcaoList() {
            const lista = container.querySelector('#lista-atividades');
            lista.innerHTML = atividadesPlanoAcao.map((atividade, index) => {
                const prazo = new Date(atividade.prazo).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                return `<div class="atividade-item"><span><strong>${atividade.responsavel}:</strong> ${atividade.descricao} (Prazo: ${prazo})</span><button type="button" class="remove-activity-btn" data-index="${index}">X</button></div>`;
            }).join('');
        }
        
        function setupEventListeners() {
            container.addEventListener('change', function(e) {
                if (e.target.classList.contains('ata-tipo')) {
                    const tipo = e.target.value;
                    const pautaLabel = container.querySelector('#pauta-label');
                    container.querySelectorAll('.tecnica-field, .gestao-field, .gestor-select-field, .participantes-field').forEach(el => el.style.display = 'none');
                    
                    if (tipo === 'Reunião Técnica') {
                        container.querySelectorAll('.tecnica-field').forEach(el => el.style.display = 'block');
                        container.querySelector('.duracao-field-container').style.display = 'none';
                        pautaLabel.textContent = 'Tema da Reunião';
                    } else {
                        container.querySelectorAll('.gestao-field').forEach(el => el.style.display = 'block');
                        pautaLabel.textContent = 'Pauta da Reunião';
                        if (tipo === 'Reunião Conselho administrativo') {
                            container.querySelector('.participantes-field').style.display = 'block';
                            container.querySelector('.participantes-checkbox-container').style.display = 'grid';
                        } else if (tipo === 'Reunião com Gestor') {
                            container.querySelector('.gestor-select-field').style.display = 'block';
                        } else if (tipo === 'Outros') {
                            container.querySelector('.participantes-field').style.display = 'block';
                            container.querySelector('.ata-participantes-input').style.display = 'block';
                        }
                    }
                }
            });

            container.addEventListener('click', async function(e) {
                if (e.target.id === 'add-activity') {
                    const errorSpan = container.querySelector('#activity-error-feedback');
                    const responsavel = container.querySelector('#plano-responsavel').value;
                    const descricao = container.querySelector('#plano-descricao').value;
                    const prazo = container.querySelector('#plano-prazo').value;

                    if (responsavel && descricao && prazo) {
                        atividadesPlanoAcao.push({responsavel, descricao, prazo, status: 'A Fazer'});
                        renderPlanoAcaoList();
                        container.querySelector('#plano-descricao').value = '';
                        container.querySelector('#plano-prazo').value = '';
                        container.querySelector('#plano-responsavel').value = '';
                        errorSpan.textContent = '';
                    } else {
                        errorSpan.textContent = 'Preencha todos os campos da atividade.';
                    }
                }

                if (e.target.classList.contains('remove-activity-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'), 10);
                    atividadesPlanoAcao.splice(index, 1);
                    renderPlanoAcaoList();
                }

                if (e.target.classList.contains('save-btn')) {
                    await handleSaveAta(e.target);
                }
            });
        }

        async function handleSaveAta(saveButton) {
            const originalButtonText = saveButton.textContent;
            const statusBox = container.querySelector('#form-status-message');
            statusBox.style.display = 'none';
            let hasErrors = false;
            
            container.querySelectorAll('.error-message').forEach(span => span.textContent = '');
            const validate = (selector, condition, message = "Campo obrigatório.") => {
                const element = container.querySelector(selector);
                const formGroup = element.closest('.form-group');
                if (condition && formGroup && formGroup.style.display !== 'none') {
                    formGroup.querySelector('.error-message').textContent = message;
                    hasErrors = true;
                }
            };
            
            const tipo = container.querySelector('.ata-tipo').value;
            validate('.ata-tipo', !tipo);
            // ... (o resto da sua lógica de validação) ...
            
            if (hasErrors) {
                statusBox.textContent = 'Por favor, preencha todos os campos obrigatórios.';
                statusBox.className = 'status-message error';
                return;
            }

            saveButton.textContent = 'Gerando Documento...';
            saveButton.disabled = true;
            
            // ... (o resto da sua lógica para coletar dados e salvar) ...
            
            // Exemplo de como coletar os dados
            const dataToSave = { /* ... seu objeto de dados ... */ };
            
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(dataToSave) });
                if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Erro no script do Google.');

                dataToSave.pdfUrl = result.fileUrl;
                saveButton.textContent = 'Salvando dados...';
                await database.ref(`gestao/atas/ata_${Date.now()}`).set(dataToSave);

                container.innerHTML = `<div class="message-box success"><h2>Ata Salva com Sucesso!</h2><p>O Documento foi salvo e o registro guardado.</p></div><br><button class="action-button" style="background-color:#007bff; float:right;" id="register-new-ata">Registrar Nova Ata</button>`;
                container.querySelector('#register-new-ata').addEventListener('click', createNewAtaForm);

            } catch (error) {
                statusBox.textContent = 'Falha ao salvar: ' + error.message;
                statusBox.className = 'status-message error';
                saveButton.textContent = originalButtonText;
                saveButton.disabled = false;
            }
        }

        // Inicia o formulário quando a página é carregada
        createNewAtaForm();
    })();
</script>